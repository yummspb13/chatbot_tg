# Настройка Cloudinary для загрузки изображений

## Описание

Изображения загружаются в Cloudinary **только при одобрении** черновика (когда нажимают "Принять"). Это предотвращает загрузку всех изображений подряд и экономит ресурсы.

## Переменные окружения

Добавьте следующие переменные в **Vercel** (для основного приложения):

```
CLOUDINARY_CLOUD_NAME=dkbh2wihq
CLOUDINARY_API_KEY=246521541339249
CLOUDINARY_API_SECRET=ps0PRzY_Mxex1Kfl0OutqaH-98o
```

## Как это работает

1. **Worker скачивает файлы через Client API**
   - Worker получает сообщение из канала
   - Скачивает изображения через `client.downloadMedia()`
   - Передает их как base64 в webhook

2. **При получении сообщения (handleChannelMessage)**
   - Изображения сохраняются в базу данных как `base64:...`
   - **НЕ загружаются в Cloudinary** на этом этапе

3. **При одобрении (handleApprove)**
   - Изображения загружаются в Cloudinary из base64 буферов
   - Получаем Cloudinary URL
   - Отправляем Cloudinary URL в Афишу

## Структура папок в Cloudinary

Изображения сохраняются в папке:
```
afisha-bot/approved/
```

## Проверка работы

1. Отправьте сообщение с изображением в тестовый канал
2. Проверьте, что в базе данных `coverImage` начинается с `base64:`
3. Нажмите "Принять" на черновике
4. Проверьте логи Vercel - должны быть сообщения:
   - `[handleApprove] Загружаю coverImage в Cloudinary...`
   - `[handleApprove] ✅ CoverImage загружен в Cloudinary из Buffer: ...`
5. Проверьте, что в Афишу отправляется Cloudinary URL (не base64)

## Обработка ошибок

- Если Cloudinary недоступен, используется оригинальный URL (если есть)
- Если base64 буфер невалидный, изображение пропускается
- Если загрузка не удалась, отправляется в Афишу без изображения (но с остальными данными)

