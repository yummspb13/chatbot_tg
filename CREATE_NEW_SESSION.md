# Создание новой сессии для Worker

## Пошаговая инструкция

### Шаг 1: Откройте админ-панель QR-авторизации

Откройте в браузере:
```
https://chatbot-tg.vercel.app/admin/qr-auth
```

**Важно**: Убедитесь, что вы авторизованы в админ-панели (`/admin/login`).

### Шаг 2: Отсканируйте QR-код

1. На странице появится QR-код
2. Откройте Telegram на телефоне с аккаунтом **@yummspb**
3. Перейдите в **Настройки → Устройства**
4. Нажмите **"Подключить устройство"**
5. Отсканируйте QR-код (как при входе в Telegram Desktop/Web)
6. Подтвердите подключение на телефоне

**⏱ QR-код действителен 15 минут**

### Шаг 3: Дождитесь авторизации

После сканирования QR-кода:
- Страница автоматически обновляется каждые 2 секунды
- Когда авторизация успешна, появится сообщение **"✅ Авторизация успешна!"**
- На странице отобразится `TELEGRAM_SESSION_STRING`

### Шаг 4: Скопируйте TELEGRAM_SESSION_STRING

1. Найдите на странице поле с `TELEGRAM_SESSION_STRING`
2. Скопируйте всю строку (она начинается с `1BVtsOHwBu...`)

**⚠️ ВАЖНО**: Это длинная строка, скопируйте её полностью!

### Шаг 5: Добавьте сессию в Render.com

1. Откройте [Render.com Dashboard](https://dashboard.render.com)
2. Найдите ваш сервис Worker (например, `chatbot-tg`)
3. Перейдите в **Environment** (или **Environment Variables**)
4. Найдите переменную `TELEGRAM_SESSION_STRING`
5. Нажмите **Edit** (или **Add** если её нет)
6. Вставьте скопированную строку
7. Нажмите **Save Changes**

### Шаг 6: Перезапустите Worker

1. В Render.com Dashboard найдите ваш сервис
2. Нажмите **Manual Deploy** → **Deploy latest commit**
3. Или просто подождите автоматического перезапуска (Render перезапустит сервис при изменении переменных окружения)

### Шаг 7: Проверьте логи

После перезапуска проверьте логи Render.com:

**✅ Успешно:**
```
✅ Подключен к Telegram через Client API
✅ Соединение с Telegram подтверждено (getMe успешен)
✅ Мониторинг запущен
```

**❌ Ошибка:**
```
❌ ОШИБКА: AUTH_KEY_DUPLICATED
⚠️ Сессия используется одновременно в нескольких местах!
```

Если видите ошибку `AUTH_KEY_DUPLICATED`, см. `FIX_AUTH_KEY_DUPLICATED.md`.

---

## Альтернативный способ (через Worker API напрямую)

Если админ-панель недоступна, можно использовать Worker API напрямую:

### 1. Создайте QR-код

```bash
curl -X POST https://chatbot-tg.onrender.com/auth/qr/start
```

Ответ:
```json
{
  "qrCode": "data:image/png;base64,...",
  "authToken": "abc123...",
  "expiresIn": 900
}
```

### 2. Проверяйте статус

```bash
curl -X POST https://chatbot-tg.onrender.com/auth/qr/status \
  -H "Content-Type: application/json" \
  -d '{"authToken": "abc123..."}'
```

### 3. Когда статус `success`, получите сессию

В ответе будет `sessionString` - это и есть `TELEGRAM_SESSION_STRING`.

---

## Проверка работы

После добавления сессии и перезапуска Worker:

1. **Проверьте логи Render.com** - должны быть сообщения об успешном подключении
2. **Отправьте тестовое сообщение** в канал, который отслеживается
3. **Проверьте Vercel логи** - должно появиться сообщение в webhook

---

## Если что-то пошло не так

### QR-код не появляется
- Проверьте, что Worker доступен: `https://chatbot-tg.onrender.com/health`
- Проверьте логи Render.com на наличие ошибок

### Авторизация не проходит
- Убедитесь, что сканируете QR-код правильным аккаунтом (@yummspb)
- Проверьте, что QR-код не истек (действителен 15 минут)
- Попробуйте создать новый QR-код (обновите страницу)

### Сессия не работает после добавления
- Убедитесь, что скопировали сессию полностью (без пробелов)
- Проверьте, что Worker перезапустился после изменения переменных
- Проверьте логи Render.com на наличие ошибок

