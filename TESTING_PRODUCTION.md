# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## üß™ –ü–æ–ª–Ω—ã–π flow —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ webhook, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª–Ω—ã–π flow:

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook endpoint

```bash
curl https://chatbot-tg.vercel.app/api/tg/webhook
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "environment": "production",
  "aiProvider": "openai",
  "aiProviderStatus": "openai",
  "timestamp": "2025-01-11T..."
}
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** `aiProvider` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `"openai"`, –Ω–µ `"mock"`!

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
npm run check:production:env
```

–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ.

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

```bash
npm run webhook:check
```

Webhook –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Vercel URL.

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ flow

1. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   - –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±—ã—Ç–∏–∏ (–¥–∞—Ç–∞, –≤—Ä–µ–º—è, –º–µ—Å—Ç–æ)

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Worker**
   - –û—Ç–∫—Ä–æ–π—Ç–µ Render.com Dashboard ‚Üí –≤–∞—à Worker ‚Üí Logs
   - –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
     ```
     üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ ...
     üîÑ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –Ω–∞ https://your-app.vercel.app/api/tg/webhook...
     ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É —á–µ—Ä–µ–∑ webhook
     ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel**
   - –û—Ç–∫—Ä–æ–π—Ç–µ Vercel Dashboard ‚Üí –≤–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí Logs
   - –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
     ```
     üöÄ Webhook endpoint initialized
        Environment: PRODUCTION
        AI Provider: OPENAI (openai)
     üì• WEBHOOK RECEIVED: message
     üì® MESSAGE: ...
     ‚úÖ WEBHOOK: processed in ...ms
     ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä—É–ø–ø—É Telegram**
   - –û—Ç–∫—Ä–æ–π—Ç–µ –≥—Ä—É–ø–ø—É —Å ID `-4993347411`
   - –î–æ–ª–∂–Ω–∞ –ø—Ä–∏–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ–±—ã—Ç–∏–∏
   - –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–Ω–æ–ø–∫–∏ "–û–¥–æ–±—Ä–∏—Ç—å" –∏ "–û—Ç–∫–∞–∑–∞—Ç—å"

5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–Ω–æ–ø–æ–∫**
   - –ù–∞–∂–º–∏—Ç–µ "–û–¥–æ–±—Ä–∏—Ç—å" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
   - –°–æ–±—ã—Ç–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
     ```
     üîò CALLBACK_QUERY: ...
     ‚úÖ –°–æ–±—ã—Ç–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ
     ```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **Worker –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `MAIN_APP_URL` –≤ Worker
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Vercel –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Worker –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

2. **Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook —á–µ—Ä–µ–∑ `npm run webhook:check`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel

3. **AI –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `AI_PROVIDER=openai` –≤ Vercel
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `OPENAI_API_KEY` –≤ Vercel
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `AI Provider: OPENAI`

4. **–ö–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –≥—Ä—É–ø–ø—É:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `TELEGRAM_PUBLISH_GROUP_ID=-4993347411` –≤ Vercel
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

## üìä –ß–µ–∫–ª–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- [ ] Webhook endpoint –æ—Ç–≤–µ—á–∞–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `aiProvider: "openai"`
- [ ] `npm run check:production:env` –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] `npm run webhook:check` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π webhook
- [ ] –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è Worker
- [ ] Worker —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ webhook
- [ ] Vercel –ø–æ–ª—É—á–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook
- [ ] –í –ª–æ–≥–∞—Ö Vercel –≤–∏–¥–Ω–æ `AI Provider: OPENAI`
- [ ] –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≥—Ä—É–ø–ø—É `-4993347411`
- [ ] –ö–Ω–æ–ø–∫–∏ "–û–¥–æ–±—Ä–∏—Ç—å"/"–û—Ç–∫–∞–∑–∞—Ç—å" —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
npm run check:production:env

# –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
npm run webhook:check

# –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook endpoint
curl https://your-app.vercel.app/api/tg/webhook

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook
npm run webhook:info
```

## üìù –õ–æ–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –£—Å–ø–µ—à–Ω—ã–π flow –≤ –ª–æ–≥–∞—Ö Worker:
```
üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ –¢–µ—Å—Ç –ö–∏–¥–¥ (-1003442736774)
üîÑ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –Ω–∞ https://your-app.vercel.app/api/tg/webhook...
üì• Response status: 200 OK
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É —á–µ—Ä–µ–∑ webhook
```

### –£—Å–ø–µ—à–Ω—ã–π flow –≤ –ª–æ–≥–∞—Ö Vercel:
```
üöÄ Webhook endpoint initialized
   Environment: PRODUCTION
   AI Provider: OPENAI (openai)
üì• WEBHOOK RECEIVED: message
üì® MESSAGE: chatType=channel, chatId=-1003442736774, ...
‚úÖ WEBHOOK: processed in 1234ms
```

### –ü—Ä–æ–±–ª–µ–º—ã –≤ –ª–æ–≥–∞—Ö Worker:
```
‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç—É: fetch failed
   üîç Webhook URL: https://your-app.vercel.app/api/tg/webhook
   üîç Environment: MAIN_APP_URL=not set, BOT_WEBHOOK_URL=not set
```
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `MAIN_APP_URL` –≤ Worker

### –ü—Ä–æ–±–ª–µ–º—ã –≤ –ª–æ–≥–∞—Ö Vercel:
```
ü§ñ AI Provider: MOCK (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
‚ö†Ô∏è  WARNING: Using MOCK AI provider in PRODUCTION!
```
‚Üí –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `AI_PROVIDER=openai` –≤ Vercel

