# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–∞ –ª–æ–∫–∞–ª—å–Ω–æ

## üìã –ü–æ–ª–Ω—ã–π Flow

### 1. –í–æ—Ä–∫–µ—Ä (worker/src/monitor.ts)
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∫–∞–Ω–∞–ª—ã —á–µ—Ä–µ–∑ Telegram Client API
- ‚úÖ –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –±–æ—Ç—É —á–µ—Ä–µ–∑ webhook: `http://localhost:3000/api/tg/webhook`

### 2. –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —á–µ—Ä–µ–∑ webhook
- `app/api/tg/webhook/route.ts` - –ø–æ–ª—É—á–∞–µ—Ç update
- –í—ã–∑—ã–≤–∞–µ—Ç `handleChannelMessage()` –∏–∑ `lib/telegram/messageHandler.ts`

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ (lib/telegram/messageHandler.ts)
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ OpenAI
- –°–æ–∑–¥–∞–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ (DraftEvent) –≤ –ë–î
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É

---

## üöÄ –ó–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç–µ Next.js —Å–µ—Ä–≤–µ—Ä (–¥–ª—è webhook)

```bash
npm run dev
```

Webhook –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: `http://localhost:3000/api/tg/webhook`

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤–æ—Ä–∫–µ—Ä

```bash
cd worker
npm run dev
```

–ò–ª–∏ –∏–∑ –∫–æ—Ä–Ω—è:
```bash
npm run worker:dev
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤–æ—Ä–∫–µ—Ä–∞

–í `worker/.env` –∏–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º `.env` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:

```env
# Telegram Client API
TELEGRAM_API_ID=...
TELEGRAM_API_HASH=...
TELEGRAM_SESSION_STRING=...

# –°–≤—è–∑—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
MAIN_APP_URL=http://localhost:3000
BOT_API_KEY=...

# –ö–∞–Ω–∞–ª—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
MONITOR_CHANNELS=[{"chatId":"-100...","title":"..."}]
```

### –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—Å—è
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ–±—ã—Ç–∏–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ ...
   üîÑ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –Ω–∞ http://localhost:3000/api/tg/webhook
   ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É —á–µ—Ä–µ–∑ webhook
   ```
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Next.js - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   üì• WEBHOOK RECEIVED: message
   üì® MESSAGE: chatType=channel
   ```
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   üìù STEP1: CLASSIFY_MESSAGE
   üìù STEP2: EXTRACT_EVENT
   üìù STEP3: CREATE_DRAFT
   üìù STEP7: SEND_APPROVAL_CARD
   ```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–æ—Ä–∫–µ—Ä –∑–∞–ø—É—â–µ–Ω
```bash
ps aux | grep "tsx.*worker"
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞
–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
- `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ Telegram —á–µ—Ä–µ–∑ Client API`
- `üì° –ù–∞—á–∏–Ω–∞—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ X –∫–∞–Ω–∞–ª–æ–≤...`
- `üìã –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤:`

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–∞–Ω–∞–ª—ã –º–æ–Ω–∏—Ç–æ—Ä—è—Ç—Å—è
–í –ª–æ–≥–∞—Ö –≤–æ—Ä–∫–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
üìã –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤:
   - –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ (-100...)
```

### 4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
- –í–æ—Ä–∫–µ—Ä: `üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞`
- Next.js: `üì• WEBHOOK RECEIVED: message`
- –û–±—Ä–∞–±–æ—Ç–∫–∞: `üìù STEP1: CLASSIFY_MESSAGE`

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã

### –í–æ—Ä–∫–µ—Ä –Ω–µ –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `TELEGRAM_SESSION_STRING` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ `MONITOR_CHANNELS` –∏–ª–∏ –≤ –ë–î
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∞–∫–∫–∞—É–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª—ã

### –í–æ—Ä–∫–µ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–æ—Ç—É
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `MAIN_APP_URL=http://localhost:3000`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Next.js —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `BOT_API_KEY` - –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

### –ë–æ—Ç –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Next.js - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `üì• WEBHOOK RECEIVED`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `handleChannelMessage` - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ `üìù STEP1`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î - –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å—Å—è `DraftEvent`

---

## üìù –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤ –∫–∞–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞:

```
üé≠ –ö–æ–Ω—Ü–µ—Ä—Ç –≥—Ä—É–ø–ø—ã "–†–æ–∫-–Ω-—Ä–æ–ª–ª"
üìÖ 15 –Ω–æ—è–±—Ä—è, 20:00
üìç –ö–ª—É–± "–†–æ–∫-–±–∞—Ä"
üí∞ 1500 —Ä—É–±

–ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç!
```

–ë–æ—Ç –¥–æ–ª–∂–µ–Ω:
1. –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ —Å–æ–±—ã—Ç–∏–µ
2. –ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ (–¥–∞—Ç–∞, –º–µ—Å—Ç–æ, —Ü–µ–Ω–∞)
3. –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ

