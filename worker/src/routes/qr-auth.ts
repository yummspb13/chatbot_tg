/**
 * QR-Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Telegram Client API
 * Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ² Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğµ (Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ)
 */

import { Router } from 'express'
import { TelegramClient } from 'telegram'
import { StringSession } from 'telegram/sessions'
import { Api } from 'telegram/tl'
import qrcode from 'qrcode'

const router = Router()

// Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ credentials (Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
const DEFAULT_API_ID = 17349
const DEFAULT_API_HASH = '344583e45741c457fe1862106095a5eb'

// Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ÑĞµÑÑĞ¸Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (Ğ² Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Redis)
const authSessions = new Map<string, {
  client: TelegramClient
  expiresAt: number
  authResolved?: boolean
  authSessionString?: string | null
  authPasswordRequired?: boolean
  migrateToDcId?: number
  migrateToken?: Buffer
}>()

/**
 * POST /auth/qr/start
 * ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ QR-Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
 * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ QR-ĞºĞ¾Ğ´ Ğ¸ authToken Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
 */
router.post('/start', async (req, res) => {
  console.log('')
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
  console.log('ğŸ”µ [Worker] POST /auth/qr/start')
  console.log('   Ğ’Ñ€ĞµĞ¼Ñ:', new Date().toISOString())
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
  
  try {
    const apiId = process.env.TELEGRAM_API_ID ? parseInt(process.env.TELEGRAM_API_ID) : DEFAULT_API_ID
    const apiHash = process.env.TELEGRAM_API_HASH || DEFAULT_API_HASH

    console.log('   [Worker] API ID:', apiId)
    console.log('   [Worker] API Hash:', apiHash ? 'ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½' : 'Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½')

    const session = new StringSession('')
    const client = new TelegramClient(session, apiId, apiHash, {
      connectionRetries: 5,
    })

    console.log('   [Worker] ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ÑÑÑŒ Ğº Telegram...')
    await client.connect()
    console.log('   [Worker] âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğº Telegram')

    // Ğ’ĞĞ–ĞĞ: ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ´ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾
    // Ğ­Ñ‚Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² Ğ¸ Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
    try {
      if ((client as any)._eventBuilders) {
        (client as any)._eventBuilders = []
        console.log('   [Worker] ğŸ§¹ ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ñ‹ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹')
      }
    } catch (e) {
      // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞµ
    }
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    client.addEventHandler(async (event: any) => {
      try {
        if (event instanceof Api.UpdateLoginToken) {
          console.log('   [Worker] ğŸ“± ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: QR-ĞºĞ¾Ğ´ Ğ¾Ñ‚ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½!')
          
          // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞµÑÑĞ¸Ñ Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ Ğ¸Ğ»Ğ¸ Ğ¸Ñ‰ĞµĞ¼)
          let sessionEntry: any = (client as any)._authSessionEntry || null
          
          if (!sessionEntry) {
            for (const [token, session] of authSessions.entries()) {
              if (session.client === client) {
                sessionEntry = session
                break
              }
            }
          }

          if (!sessionEntry) {
            console.log('   [Worker] âš ï¸ Ğ¡ĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ')
            return
          }
          
          // ĞŸĞ¾ÑĞ»Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ QR-ĞºĞ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ExportLoginToken
          // Ğ’ĞĞ–ĞĞ: Ğ”ĞµĞ»Ğ°ĞµĞ¼ ÑÑ‚Ğ¾ ÑÑ€Ğ°Ğ·Ñƒ, Ğ¿Ğ¾ĞºĞ° Ñ‚Ğ¾ĞºĞµĞ½ Ğ½Ğµ Ğ¸ÑÑ‚ĞµĞº
          try {
            console.log('   [Worker] ğŸ”„ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ ExportLoginToken Ğ¿Ğ¾ÑĞ»Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ QR...')
            const result = await client.invoke(
              new Api.auth.ExportLoginToken({
                apiId,
                apiHash,
                exceptIds: [],
              })
            )

            if (result instanceof Api.auth.LoginTokenSuccess) {
              console.log('   [Worker] âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹!')
              const sessionString = client.session.save() as unknown as string
              sessionEntry.authResolved = true
              sessionEntry.authSessionString = sessionString
              console.log('   [Worker] Ğ¡ĞµÑÑĞ¸Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°, Ğ´Ğ»Ğ¸Ğ½Ğ°:', sessionString.length)
            } else if (result instanceof Api.auth.LoginToken) {
              // QR-ĞºĞ¾Ğ´ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¾Ñ‚ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¶Ğ´Ğ°Ñ‚ÑŒ
              console.log('   [Worker] â³ QR-ĞºĞ¾Ğ´ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¾Ñ‚ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¶Ğ´Ğ°Ñ‚ÑŒ...')
            } else if (result instanceof Api.auth.LoginTokenMigrateTo) {
              console.log('   [Worker] ğŸ”„ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° DC:', result.dcId)
              console.log('   [Worker] Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ ImportLoginToken Ğ´Ğ»Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (ÑÑ€Ğ°Ğ·Ñƒ, Ğ¿Ğ¾ĞºĞ° Ñ‚Ğ¾ĞºĞµĞ½ Ğ½Ğµ Ğ¸ÑÑ‚ĞµĞº)...')
              
              // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼
              sessionEntry.migrateToDcId = result.dcId
              sessionEntry.migrateToken = result.token
              
              // Ğ’ĞĞ–ĞĞ: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ ÑÑ€Ğ°Ğ·Ñƒ, Ğ½Ğµ Ğ´Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑÑŒ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ
              // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ImportLoginToken Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ (Telegram Client API Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ)
              try {
                console.log('   [Worker] âš¡ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒÑ Ñ‚Ğ¾ĞºĞµĞ½ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾...')
                const migrateResult = await client.invoke(
                  new Api.auth.ImportLoginToken({
                    token: result.token,
                  })
                )
                
                console.log('   [Worker] Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸:', migrateResult.constructor.name)
                
                if (migrateResult instanceof Api.auth.LoginTokenSuccess) {
                  console.log('   [Worker] âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸!')
                  const sessionString = client.session.save() as unknown as string
                  sessionEntry.authResolved = true
                  sessionEntry.authSessionString = sessionString
                  console.log('   [Worker] Ğ¡ĞµÑÑĞ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸, Ğ´Ğ»Ğ¸Ğ½Ğ°:', sessionString.length)
                } else {
                  console.log('   [Worker] âš ï¸ ĞŸĞ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ½ĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:', migrateResult.constructor.name)
                  // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· getMe, Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
                  console.log('   [Worker] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Ñ‡ĞµÑ€ĞµĞ· getMe()...')
                  try {
                    const me = await client.getMe()
                    console.log('   [Worker] âœ… getMe() ÑƒÑĞ¿ĞµÑˆĞµĞ½, Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½:', me.id)
                    // Ğ•ÑĞ»Ğ¸ getMe ÑƒÑĞ¿ĞµÑˆĞµĞ½, Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°
                    const sessionString = client.session.save() as unknown as string
                    sessionEntry.authResolved = true
                    sessionEntry.authSessionString = sessionString
                  } catch (getMeError: any) {
                    console.log('   [Worker] âŒ getMe() Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:', getMeError.errorMessage || getMeError.message)
                    // Ğ’ĞĞ–ĞĞ: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ»Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
                    // Ğ•ÑĞ»Ğ¸ 2FA Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ°, Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
                    if (getMeError.errorMessage?.includes('PASSWORD') || 
                        getMeError.errorMessage?.includes('SESSION_PASSWORD_NEEDED')) {
                      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ° 2FA
                      try {
                        const passwordInfo = await client.invoke(new Api.account.GetPassword())
                        if (passwordInfo && passwordInfo.hasPassword) {
                          console.log('   [Worker] âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ 2FA (2FA Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ°)')
                          sessionEntry.authPasswordRequired = true
                        } else {
                          console.log('   [Worker] âœ… 2FA Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ°, Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ')
                          // ĞĞµ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
                        }
                      } catch (checkPasswordError: any) {
                        // Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
                        console.log('   [Worker] âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ 2FA, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ñ Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ')
                      }
                    }
                    // Ğ•ÑĞ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° (Ğ½Ğµ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼), Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
                  }
                }
              } catch (migrateError: any) {
                console.log('   [Worker] âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸:', migrateError.errorMessage || migrateError.message)
                
                // Ğ•ÑĞ»Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½ Ğ¸ÑÑ‚ĞµĞº, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· getMe - Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞµÑÑĞ¸Ñ ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°
                if (migrateError.errorMessage?.includes('AUTH_TOKEN_EXPIRED') ||
                    migrateError.errorMessage?.includes('TOKEN_EXPIRED')) {
                  console.log('   [Worker] âš ï¸ Ğ¢Ğ¾ĞºĞµĞ½ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ÑÑ‚ĞµĞº, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ Ñ‡ĞµÑ€ĞµĞ· getMe()...')
                  try {
                    const me = await client.getMe()
                    console.log('   [Worker] âœ… getMe() ÑƒÑĞ¿ĞµÑˆĞµĞ½ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°:', me.id)
                    // Ğ•ÑĞ»Ğ¸ getMe ÑƒÑĞ¿ĞµÑˆĞµĞ½, Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°
                    const sessionString = client.session.save() as unknown as string
                    sessionEntry.authResolved = true
                    sessionEntry.authSessionString = sessionString
                    console.log('   [Worker] Ğ¡ĞµÑÑĞ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°')
                  } catch (getMeError: any) {
                    console.log('   [Worker] âŒ getMe() Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°:', getMeError.errorMessage || getMeError.message)
                    // Ğ’ĞĞ–ĞĞ: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ»Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
                    if (getMeError.errorMessage?.includes('PASSWORD') || 
                        getMeError.errorMessage?.includes('SESSION_PASSWORD_NEEDED')) {
                      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ° 2FA
                      try {
                        const passwordInfo = await client.invoke(new Api.account.GetPassword())
                        if (passwordInfo && passwordInfo.hasPassword) {
                          console.log('   [Worker] âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ 2FA (2FA Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ°)')
                          sessionEntry.authPasswordRequired = true
                        } else {
                          console.log('   [Worker] âœ… 2FA Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ°, Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ')
                          // ĞĞµ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
                        }
                      } catch (checkPasswordError: any) {
                        console.log('   [Worker] âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ 2FA, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ñ Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ')
                      }
                    }
                    // Ğ•ÑĞ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
                  }
                } else if (migrateError.errorMessage?.includes('PASSWORD') || 
                    migrateError.errorMessage?.includes('SESSION_PASSWORD_NEEDED') ||
                    migrateError.message?.includes('PASSWORD')) {
                  console.log('   [Worker] âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ 2FA Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ¸Ğ· Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸)')
                  sessionEntry.authPasswordRequired = true
                } else {
                  // Ğ•ÑĞ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· getMe
                  console.log('   [Worker] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Ñ‡ĞµÑ€ĞµĞ· getMe() Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸...')
                  try {
                    const me = await client.getMe()
                    console.log('   [Worker] âœ… getMe() ÑƒÑĞ¿ĞµÑˆĞµĞ½ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸:', me.id)
                    const sessionString = client.session.save() as unknown as string
                    sessionEntry.authResolved = true
                    sessionEntry.authSessionString = sessionString
                  } catch (getMeError: any) {
                    console.log('   [Worker] âŒ getMe() Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸:', getMeError.errorMessage || getMeError.message)
                    if (getMeError.errorMessage?.includes('PASSWORD') || 
                        getMeError.errorMessage?.includes('SESSION_PASSWORD_NEEDED')) {
                      console.log('   [Worker] âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ 2FA (Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· getMe)')
                      sessionEntry.authPasswordRequired = true
                    } else {
                      // Ğ•ÑĞ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ²ÑĞµ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
                      console.log('   [Worker] âš ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ Ñ„Ğ»Ğ°Ğ³ password_required Ğ¸Ğ·-Ğ·Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ getMe')
                      sessionEntry.authPasswordRequired = true
                    }
                  }
                }
              }
            }
          } catch (error: any) {
            if (error.errorMessage?.includes('PASSWORD') || error.errorMessage?.includes('SESSION_PASSWORD_NEEDED')) {
              console.log('   [Worker] âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ 2FA')
              sessionEntry.authPasswordRequired = true
            }
          }
        }
      } catch (error) {
        console.error('   [Worker] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹:', error)
      }
    })

    // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ QR-ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    console.log('   [Worker] Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ñ QR-ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸...')
    const result = await client.invoke(
      new Api.auth.ExportLoginToken({
        apiId,
        apiHash,
        exceptIds: [],
      })
    )

    if (result instanceof Api.auth.LoginToken) {
      // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ QR-ĞºĞ¾Ğ´
      const tokenBase64 = Buffer.from(result.token).toString('base64url')
      const qrData = `tg://login?token=${tokenBase64}`
      
      const qrCodeBase64 = await qrcode.toDataURL(qrData, {
        errorCorrectionLevel: 'M',
        type: 'image/png',
        width: 300,
        margin: 2,
      })

      // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
      const authToken = Buffer.from(result.token).toString('hex')
      authSessions.set(authToken, {
        client,
        expiresAt: Date.now() + 15 * 60 * 1000, // 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        authResolved: false,
        authSessionString: null,
        authPasswordRequired: false,
      })

      console.log('   [Worker] âœ… QR-ĞºĞ¾Ğ´ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾')
      console.log('   [Worker] AuthToken:', authToken.substring(0, 20) + '...')
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
      console.log('')
      
      return res.json({
        qrCode: qrCodeBase64,
        authToken,
        expiresIn: 15 * 60, // ÑĞµĞºÑƒĞ½Ğ´Ñ‹
      })
    }

    if (result instanceof Api.auth.LoginTokenSuccess) {
      // Ğ£Ğ¶Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
      const sessionString = client.session.save() as unknown as string
      return res.json({
        qrCode: null,
        sessionString,
        success: true,
      })
    }

    throw new Error('ĞĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°')
  } catch (error: any) {
    console.error('')
    console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.error('âŒ [Worker] ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ QR-ĞºĞ¾Ğ´Ğ°')
    console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.error('   Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:', error.message)
    console.error('   errorMessage:', error.errorMessage)
    console.error('   errorCode:', error.errorCode)
    console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.error('')
    
    return res.status(500).json({
      error: error.message || error.errorMessage || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ QR-ĞºĞ¾Ğ´Ğ°',
    })
  }
})

/**
 * POST /auth/qr/status
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ QR-Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
 */
router.post('/status', async (req, res) => {
  try {
    const { authToken } = req.body

    if (!authToken) {
      return res.status(400).json({ error: 'authToken Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½' })
    }

    const sessionData = authSessions.get(authToken)
    if (!sessionData) {
      return res.json({ status: 'expired' })
    }

    if (Date.now() > sessionData.expiresAt) {
      authSessions.delete(authToken)
      return res.json({ status: 'expired' })
    }

    const { client } = sessionData

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ Ğ»Ğ¸ Ğ¼Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
    if (sessionData.authResolved && sessionData.authSessionString) {
      console.log('   [Worker] âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹!')
      authSessions.delete(authToken)
      
      try {
        await client.disconnect()
      } catch (e) {
        // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
      }
      
      return res.json({
        status: 'success',
        sessionString: sessionData.authSessionString,
      })
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
    if (sessionData.authPasswordRequired) {
      return res.json({
        status: 'password_required',
        hint: 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ²ÑƒÑ…Ñ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸',
      })
    }

    // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ
    // Ğ­Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ¶Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸, ĞµÑĞ»Ğ¸ ÑĞµÑÑĞ¸Ñ Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°
    try {
      console.log('   [Worker] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· getMe()...')
      const me = await client.getMe()
      if (me) {
        console.log('   [Worker] âœ… getMe() ÑƒÑĞ¿ĞµÑˆĞµĞ½, Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½:', me.id)
        const sessionString = client.session.save() as unknown as string
        authSessions.delete(authToken)
        
        try {
          await client.disconnect()
        } catch (e) {
          // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
        }
        
        return res.json({
          status: 'success',
          sessionString,
        })
      }
    } catch (getMeError: any) {
      console.log('   [Worker] getMe() Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:', getMeError.errorMessage || getMeError.message)
      if (getMeError.errorMessage?.includes('PASSWORD') || getMeError.errorMessage?.includes('SESSION_PASSWORD_NEEDED')) {
        // Ğ’ĞĞ–ĞĞ: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ° 2FA Ğ¿ĞµÑ€ĞµĞ´ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¾Ğ¹ Ñ„Ğ»Ğ°Ğ³Ğ°
        try {
          const passwordInfo = await client.invoke(new Api.account.GetPassword())
          if (passwordInfo && passwordInfo.hasPassword) {
            console.log('   [Worker] âš ï¸ 2FA Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ°, Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ')
            sessionData.authPasswordRequired = true
            return res.json({
              status: 'password_required',
              hint: getMeError.hint || 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ²ÑƒÑ…Ñ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸',
            })
          } else {
            console.log('   [Worker] âœ… 2FA Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ°, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ñ Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ')
            // ĞĞµ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ
          }
        } catch (checkPasswordError: any) {
          console.log('   [Worker] âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ 2FA, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ñ Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ')
          // ĞĞµ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ
        }
      }
      // Ğ•ÑĞ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, AUTH_KEY_UNREGISTERED), Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ
    }

    // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ ExportLoginToken
    try {
      const apiId = process.env.TELEGRAM_API_ID ? parseInt(process.env.TELEGRAM_API_ID) : DEFAULT_API_ID
      const apiHash = process.env.TELEGRAM_API_HASH || DEFAULT_API_HASH
      
      const exportResult = await client.invoke(
        new Api.auth.ExportLoginToken({
          apiId,
          apiHash,
          exceptIds: [],
        })
      )

      if (exportResult instanceof Api.auth.LoginTokenSuccess) {
        console.log('   [Worker] âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ ExportLoginToken!')
        const sessionString = client.session.save() as unknown as string
        authSessions.delete(authToken)
        
        try {
          await client.disconnect()
        } catch (e) {
          // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
        }
        
        return res.json({
          status: 'success',
          sessionString,
        })
      }
    } catch (exportError: any) {
      if (exportError.errorMessage?.includes('PASSWORD') || exportError.errorMessage?.includes('SESSION_PASSWORD_NEEDED')) {
        sessionData.authPasswordRequired = true
        return res.json({
          status: 'password_required',
          hint: exportError.hint || 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ²ÑƒÑ…Ñ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸',
        })
      }
    }

    return res.json({ status: 'pending' })
  } catch (error: any) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°:', error)
    return res.status(500).json({
      error: error.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°',
    })
  }
})

/**
 * POST /auth/qr/password
 * ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ²Ğ²Ğ¾Ğ´ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ 2FA
 */
router.post('/password', async (req, res) => {
  try {
    const { authToken, password } = req.body

    if (!authToken || !password) {
      return res.status(400).json({ error: 'authToken Ğ¸ password Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹' })
    }

    const sessionData = authSessions.get(authToken)
    if (!sessionData) {
      return res.status(400).json({ error: 'Ğ¡ĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ° Ğ¸Ğ»Ğ¸ Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°' })
    }

    const { client } = sessionData

    try {
      console.log('   [Worker] ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ 2FA...')
      
      // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ
      let passwordInfo
      try {
        passwordInfo = await client.invoke(new Api.account.GetPassword())
        console.log('   [Worker] âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ')
      } catch (getPasswordError: any) {
        console.log('   [Worker] âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ:', getPasswordError.errorMessage || getPasswordError.message)
        
        // Ğ•ÑĞ»Ğ¸ ÑĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼
        if (getPasswordError.errorMessage?.includes('AUTH_KEY_UNREGISTERED') || 
            getPasswordError.errorMessage?.includes('SESSION_PASSWORD_NEEDED')) {
          
          console.log('   [Worker] ğŸ”„ Ğ¡ĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°, Ğ¿Ñ€Ğ¾Ğ±ÑƒÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ...')
          
          try {
            // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ ExportLoginToken, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½
            const apiId = process.env.TELEGRAM_API_ID ? parseInt(process.env.TELEGRAM_API_ID) : DEFAULT_API_ID
            const apiHash = process.env.TELEGRAM_API_HASH || DEFAULT_API_HASH
            
            const exportResult = await client.invoke(
              new Api.auth.ExportLoginToken({
                apiId,
                apiHash,
                exceptIds: [],
              })
            )
            
            console.log('   [Worker] Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ ExportLoginToken:', exportResult.constructor.name)
            
            // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ LoginTokenMigrateTo, Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½
            if (exportResult instanceof Api.auth.LoginTokenMigrateTo) {
              console.log('   [Worker] ğŸ”„ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° DC:', exportResult.dcId)
              
              try {
                const migrateResult = await client.invoke(
                  new Api.auth.ImportLoginToken({
                    token: exportResult.token,
                  })
                )
                
                // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ LoginTokenSuccess, Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°
                if (migrateResult instanceof Api.auth.LoginTokenSuccess) {
                  const sessionString = client.session.save() as unknown as string
                  authSessions.delete(authToken)
                  
                  try {
                    await client.disconnect()
                  } catch (e) {
                    // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
                  }
                  
                  console.log('   [Worker] âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸')
                  return res.json({
                    status: 'success',
                    sessionString,
                  })
                }
                
                // Ğ•ÑĞ»Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ CheckPassword
                // ĞĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ²ÑĞµ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ
                throw new Error('ĞŸĞ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ, Ğ½Ğ¾ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.')
              } catch (migrateError: any) {
                console.log('   [Worker] âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸:', migrateError.errorMessage || migrateError.message)
                
                // Ğ•ÑĞ»Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½ Ğ¸ÑÑ‚ĞµĞº Ğ¸Ğ»Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
                if (migrateError.errorMessage?.includes('AUTH_TOKEN_EXPIRED') ||
                    migrateError.errorMessage?.includes('TOKEN_EXPIRED') ||
                    migrateError.errorMessage?.includes('PASSWORD') ||
                    migrateError.errorMessage?.includes('SESSION_PASSWORD_NEEDED')) {
                  
                  // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ñ‡ĞµÑ€ĞµĞ· CheckPassword
                  // Ğ”Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ, Ğ½Ğ¾ GetPassword Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
                  // ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ (Ğ² Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… ÑĞ»ÑƒÑ‡Ğ°ÑÑ… ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚)
                  console.log('   [Worker] ğŸ” ĞŸÑ€Ğ¾Ğ±ÑƒÑ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ...')
                  
                  try {
                    const { computeCheck } = await import('telegram/Password')
                    
                    // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ· (Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸)
                    try {
                      passwordInfo = await client.invoke(new Api.account.GetPassword())
                      console.log('   [Worker] âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸')
                      
                      const passwordCheck = await computeCheck(passwordInfo, password)
                      
                      await client.invoke(
                        new Api.auth.CheckPassword({
                          password: passwordCheck,
                        })
                      )
                      
                      const sessionString = client.session.save() as unknown as string
                      authSessions.delete(authToken)
                      
                      try {
                        await client.disconnect()
                      } catch (e) {
                        // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
                      }
                      
                      console.log('   [Worker] âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸')
                      return res.json({
                        status: 'success',
                        sessionString,
                      })
                    } catch (getPasswordError2: any) {
                      throw new Error('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¸ Ğ½Ğ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.')
                    }
                  } catch (passwordError: any) {
                    throw new Error('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¸ Ğ½Ğ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.')
                  }
                }
                
                throw migrateError
              }
            } else if (exportResult instanceof Api.auth.LoginTokenSuccess) {
              // Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
              const sessionString = client.session.save() as unknown as string
              authSessions.delete(authToken)
              
              try {
                await client.disconnect()
              } catch (e) {
                // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
              }
              
              console.log('   [Worker] âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ° Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ')
              return res.json({
                status: 'success',
                sessionString,
              })
            }
          } catch (exportError: any) {
            console.log('   [Worker] âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¼ ExportLoginToken:', exportError.errorMessage || exportError.message)
            throw new Error('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¸ Ğ½Ğ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.')
          }
        }
        
        // Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
        // Ğ’ Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… ÑĞ»ÑƒÑ‡Ğ°ÑÑ… Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ±ĞµĞ· GetPassword
        throw new Error('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.')
      }
      
      // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğµ, Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ñ…ĞµÑˆ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
      const { computeCheck } = await import('telegram/Password')
      const passwordCheck = await computeCheck(passwordInfo, password)
      
      console.log('   [Worker] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ñ‡ĞµÑ€ĞµĞ· CheckPassword...')
      
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
      await client.invoke(
        new Api.auth.CheckPassword({
          password: passwordCheck,
        })
      )

      // Ğ•ÑĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞµÑÑĞ¸Ñ
      const sessionString = client.session.save() as unknown as string
      authSessions.delete(authToken)
      
      try {
        await client.disconnect()
      } catch (e) {
        // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
      }

      console.log('   [Worker] âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°')
      return res.json({
        status: 'success',
        sessionString,
      })
    } catch (error: any) {
      console.error('   [Worker] âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ:', error)
      console.error('   [Worker] Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸:', {
        errorMessage: error.errorMessage,
        message: error.message,
        code: error.code,
      })
      
      if (error.errorMessage?.includes('PASSWORD_HASH_INVALID') || 
          error.message?.includes('PASSWORD_HASH_INVALID')) {
        return res.status(400).json({ error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ' })
      }
      
      if (error.errorMessage?.includes('AUTH_KEY_UNREGISTERED')) {
        return res.status(400).json({ 
          error: 'Ğ¡ĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¸ Ğ½Ğ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.' 
        })
      }
      
      return res.status(500).json({
        error: error.message || error.errorMessage || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ',
      })
    }
  } catch (error: any) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ:', error)
    return res.status(500).json({
      error: error.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ',
    })
  }
})

/**
 * POST /auth/qr/save
 * Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ sessionString (Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸)
 * 
 * Ğ’ĞĞ–ĞĞ: ĞĞ° Render.com ÑĞµÑÑĞ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ² Environment Variables Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ!
 * Ğ­Ñ‚Ğ¾Ñ‚ endpoint Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
 */
router.post('/save', async (req, res) => {
  try {
    const { sessionString } = req.body

    if (!sessionString) {
      return res.status(400).json({ error: 'sessionString Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½' })
    }

    console.log('')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('ğŸ’¾ [Worker] Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('   Ğ”Ğ»Ğ¸Ğ½Ğ° ÑĞµÑÑĞ¸Ğ¸:', sessionString.length)
    console.log('   ĞŸĞµÑ€Ğ²Ñ‹Ğµ 50 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²:', sessionString.substring(0, 50) + '...')
    console.log('')
    console.log('âš ï¸  Ğ’ĞĞ–ĞĞ: ĞĞ° Render.com ÑĞµÑÑĞ¸Ñ ĞĞ• ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸!')
    console.log('   Ğ’Ñ‹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞµÑ‘ Ğ² Environment Variables:')
    console.log('   1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Render Dashboard')
    console.log('   2. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Ğ²Ğ¾Ñ€ĞºĞµÑ€')
    console.log('   3. ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Environment')
    console.log('   4. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ: TELEGRAM_SESSION_STRING="' + sessionString.substring(0, 50) + '..."')
    console.log('   5. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ (Ğ²Ğ¾Ñ€ĞºĞµÑ€ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸)')
    console.log('')
    console.log('âœ… ĞŸĞ¾ÑĞ»Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ² Environment Variables Ğ²Ğ¾Ñ€ĞºĞµÑ€ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ')
    console.log('   ÑÑ‚Ñƒ ÑĞµÑÑĞ¸Ñ Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞµ (Ğ´Ğ°Ğ¶Ğµ Ğ¿Ğ¾ÑĞ»Ğµ "Ğ·Ğ°ÑÑ‹Ğ¿Ğ°Ğ½Ğ¸Ñ" Ğ½Ğ° free tier)')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('')

    // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² .env Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
    try {
      const fs = await import('fs/promises')
      const path = await import('path')
      
      const envPath = path.resolve(process.cwd(), '../.env')
      let envContent = ''

      try {
        envContent = await fs.readFile(envPath, 'utf-8')
      } catch (error: any) {
        if (error.code !== 'ENOENT') {
          throw error
        }
      }

      // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ TELEGRAM_SESSION_STRING
      if (envContent.includes('TELEGRAM_SESSION_STRING=')) {
        envContent = envContent.replace(
          /TELEGRAM_SESSION_STRING=.*/g,
          `TELEGRAM_SESSION_STRING="${sessionString}"`
        )
      } else {
        envContent += `\nTELEGRAM_SESSION_STRING="${sessionString}"\n`
      }

      await fs.writeFile(envPath, envContent, 'utf-8')
      console.log('   [Worker] âœ… Ğ¡ĞµÑÑĞ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ° Ğ² .env (Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸)')
    } catch (fsError: any) {
      // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (Ğ½Ğ° Render.com Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹)
      console.log('   [Worker] âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² .env (ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ½Ğ° Render.com)')
    }

    return res.json({ 
      success: true,
      message: 'Ğ¡ĞµÑÑĞ¸Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ°. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞµÑ‘ Ğ² Render.com Environment Variables Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ.',
      sessionString: sessionString // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞµÑÑĞ¸Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ³Ğ»Ğ° ĞµÑ‘ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ
    })
  } catch (error: any) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸:', error)
    return res.status(500).json({
      error: error.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸',
    })
  }
})

export { router as qrAuthRouter }

