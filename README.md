# Telegram Bot –¥–ª—è –ê—Ñ–∏—à–∏

Telegram-–±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∏–∑ Telegram-–∫–∞–Ω–∞–ª–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Ö –≤ —Å–∏—Å—Ç–µ–º—É –ê—Ñ–∏—à–∏ —á–µ—Ä–µ–∑ HTTP API.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üì° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Telegram-–∫–∞–Ω–∞–ª–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ (EVENT/GOING_OUT/AD)
- üìù –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö —á–µ—Ä–µ–∑ OpenAI
- üñºÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ Telegram –ø–æ—Å—Ç–æ–≤ (coverImage –∏ gallery)
- üéØ –°–∏—Å—Ç–µ–º–∞ –æ–±—É—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞ –Ω–∞ —Ä–µ—à–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üîÑ –†—É—á–Ω–æ–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã
- üéöÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞
- üèôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞–º–∏ –∏ –∫–∞–Ω–∞–ª–∞–º–∏ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
- üìä API –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±—É—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSONL –¥–ª—è fine-tuning

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Next.js 14** (App Router) + TypeScript
- **Prisma ORM** (SQLite –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, Postgres –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
- **Telegraf** –¥–ª—è Telegram Bot API
- **OpenAI API** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- **Vercel** –¥–ª—è –¥–µ–ø–ª–æ—è

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
npm install
```

2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `.env.example`:

```env
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
TELEGRAM_ADMIN_CHAT_ID=your_admin_chat_id_here
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4o-mini
BOT_API_KEY=17d38eb4c014c524e52675ab75661f0dcc8768cbc749a62e7309fabe6c9905cd
AFISHA_DRAFT_URL=https://kiddeo.vercel.app/api/bot/events/draft
DATABASE_URL="file:./dev.db"
```

3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:

```bash
npx prisma generate
npx prisma db push
npm run db:seed
```

## –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä:

```bash
npm run dev
```

2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –¥–ª—è Telegram (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏):

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å
ngrok http 3000

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook (–∑–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ –≤–∞—à ngrok URL)
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook?url=https://<ngrok-url>/api/tg/webhook"
```

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (TELEGRAM_ADMIN_CHAT_ID):

- `/start [N]` - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π)
- `/stop` - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
- `/status` - –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `/auto` - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º
- `/manual` - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º
- `/setthreshold <0.0-1.0>` - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- `/addcity <–Ω–∞–∑–≤–∞–Ω–∏–µ>` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
- `/addchannel <citySlug> <chatId> <–Ω–∞–∑–≤–∞–Ω–∏–µ>` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
- `/listchannels` - –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –∏ –∫–∞–Ω–∞–ª–æ–≤
- `/removechannel <id>` - –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–∞–Ω–∞–ª–∞

## –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º (MANUAL)

–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ "–ü—Ä–∏–Ω—è—Ç—å" / "–û—Ç–∫–∞–∑–∞—Ç—å". –ê–≥–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–µ –º–Ω–µ–Ω–∏–µ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –Ω–æ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º (AUTO)

- –ü—Ä–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–∞ >= –ø–æ—Ä–æ–≥–∞: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- –ü—Ä–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ < –ø–æ—Ä–æ–≥–∞: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É

## –°–∏—Å—Ç–µ–º–∞ –æ–±—É—á–µ–Ω–∏—è

–ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É `LearningDecision`:
- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
- –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø–æ–ª—è
- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
- –†–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞

–ê–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç-–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥.

## –î–µ–ø–ª–æ–π –Ω–∞ Vercel

1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∫ Vercel
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel Dashboard
3. –î–ª—è Postgres: –æ–±–Ω–æ–≤–∏—Ç–µ `DATABASE_URL` –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook:

```bash
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook?url=https://<your-vercel-url>/api/tg/webhook"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
/app/api/tg/webhook     - Webhook endpoint –¥–ª—è Telegram
/lib/telegram/          - Telegram –±–æ—Ç –ª–æ–≥–∏–∫–∞
/lib/openai/            - OpenAI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
/lib/afisha/            - –ö–ª–∏–µ–Ω—Ç –¥–ª—è API –ê—Ñ–∏—à–∏
/lib/learning/           - –°–∏—Å—Ç–µ–º–∞ –æ–±—É—á–µ–Ω–∏—è
/lib/db/                 - Prisma –∫–ª–∏–µ–Ω—Ç
/prisma/                 - –°—Ö–µ–º–∞ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
```

## API Endpoints

### –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –æ–±—É—á–µ–Ω–∏—è

**GET** `/api/bot/learning/export` - –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—É—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON

**POST** `/api/bot/learning/export` - –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª JSONL –¥–ª—è fine-tuning

–ó–∞–≥–æ–ª–æ–≤–∫–∏:
- `X-API-Key: <BOT_API_KEY>` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∫–∞–Ω–∞–ª–æ–≤** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
2. **Chat ID –∫–∞–Ω–∞–ª–æ–≤** –æ–±—ã—á–Ω–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `-100`
3. **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ Telegram –ø–æ—Å—Ç–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏
4. **–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π** –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è Telegram Client API (MTProto) - —Å–µ–π—á–∞—Å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞
5. **Fine-tuning –º–æ–¥–µ–ª–∏** - –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API endpoint `/api/bot/learning/export`

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

